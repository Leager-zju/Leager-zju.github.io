<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="6.s081 Lab4 Copy-on-Write Fork for Xv6, 没什么看头的地方">
    <meta name="description" content="课上谈了个 COW 优化策略，这里就要具体实现了。

#关于 COW(Copy-On-Write, 写时拷贝)
#The Problem

The fork() system call in xv6 copies all of the pa">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>6.s081 Lab4 Copy-on-Write Fork for Xv6 | 没什么看头的地方</title>
    <link rel="icon" type="image/png" href="/dt.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    


    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/comment_bg.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">没什么看头的地方</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/comment_bg.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">没什么看头的地方</div>
        <div class="logo-desc">
            
            【数据删除】
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Leager-zju" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Leager-zju" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">6.s081 Lab4 Copy-on-Write Fork for Xv6</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">这个人太懒了，都不想加标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Lab/" class="post-category">
                                Lab
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-10-30
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>课上谈了个 COW 优化策略，这里就要具体实现了。</p>
<span id="more"></span>
<h2 id="关于-COW-Copy-On-Write-写时拷贝"><a class="header-anchor" href="#关于-COW-Copy-On-Write-写时拷贝">#</a>关于 COW(Copy-On-Write, 写时拷贝)</h2>
<h3 id="The-Problem"><a class="header-anchor" href="#The-Problem">#</a>The Problem</h3>
<blockquote>
<p>The fork() system call in xv6 copies all of the parent process’s user-space memory into the child. If the parent is large, copying can take a long time. Worse, the work is often largely wasted; for example, a fork() followed by exec() in the child will cause the child to discard the copied memory, probably without ever using most of it. On the other hand, if both parent and child use a page, and one or both writes it, a copy is truly needed.</p>
</blockquote>
<p>在 xv6 中，系统调用 <code>fork()</code> 会将父进程页表中所有指向的数据页拷贝到子进程中。有些页不一定用到，用到也不一定写，那就先浅拷贝，等到要写的时候再深拷贝。</p>
<h3 id="The-Solution"><a class="header-anchor" href="#The-Solution">#</a>The Solution</h3>
<blockquote>
<p>The goal of copy-on-write (COW) fork() is to defer allocating and copying physical memory pages for the child until the copies are actually needed, if ever.</p>
<p>COW fork() creates just a pagetable for the child, with PTEs for user memory pointing to the parent’s physical pages. COW fork() marks all the user PTEs in both parent and child as not writable. When either process tries to write one of these COW pages, the CPU will force a page fault. The kernel page-fault handler detects this case, allocates a page of physical memory for the faulting process, copies the original page into the new page, and modifies the relevant PTE in the faulting process to refer to the new page, this time with the PTE marked writeable. When the page fault handler returns, the user process will be able to write its copy of the page.</p>
<p>COW fork() makes freeing of the physical pages that implement user memory a little trickier. A given physical page may be referred to by multiple processes’ page tables, and should be freed only when the last reference disappears.</p>
</blockquote>
<p>具体要怎么做呢？在原来的版本，<code>fork()</code> 会调用 <code>uvmcopy()</code> 函数，对于父进程内的每一个虚拟地址 <code>va</code>，其对应一个页表项 <code>pte</code> 及其指向的数据页 <code>pa</code>，调用 <code>kalloc()</code> 在内存中分配一个新的数据页 <code>npa</code>，将 <code>pa</code> 的内容完整拷贝到 <code>npa</code> 中，最后将 <code>pte</code> 的 <code>flag</code> 和 <code>npa</code> 组合成一个新的 <code>npte</code>，插入子进程页表中 <code>va</code> 对应的位置。</p>
<p>引入 COW 优化后，就不需要在这里进行 <code>kalloc()</code> 了。我们可以直接拷贝页表项，毕竟虚拟地址和相应的物理地址都是一样的。但注意，要将 <code>PTE_W</code> 位清除，因为这里有多个进程同时指向同一片内存，如果都允许写的话可能会产生冲突，所以这里将写的权限取消，但保留读权限。此外，还要添加一个 <code>PTE_COW</code> 位，用于标识这一页是享受到 COW 优化了的。</p>
<p>那么一旦尝试对这个虚拟地址进行写入操作，通过查页表发现没有对应物理地址的写权限，就会产生异常，进入 <code>usertrap()</code>。在这个函数中，我们就要对这种特定异常进行处理。通过查看 RISC-V 文档可知，出现该异常时，<strong>SCAUSE 寄存器中的值为 15，同时 STVAL 中的值为引起异常的虚拟地址</strong>。一旦遇到该异常，说明我们尝试写入一个 <code>PTE_W=0</code> 的页，在 COW 策略下，我们就需要在这里进行拷贝了，那第一步就是判断该虚拟地址对应的物理页是否「有资格享用 COW」。方法很简单，只需要检查页表项的 <code>PTE_V</code>，<code>PTE_U</code> 和 <code>PTE_COW</code> 位是否均为 1 即可。</p>
<p>如果通过检查，那就分配新的数据页 <code>npa</code>，并将原来的页拷贝到新页中，还有别忘了更新页表项，令其指向新的页。哦哦哦，还得设置一下标志位，毕竟指向新页后整个优化策略就与它无关了，就需要去掉 <code>PTE_COW</code>，并且加上 <code>PTE_W</code>。</p>
<blockquote>
<p>如果这里分配页失败，那就杀掉进程，处理方式为 <code>p-&gt;killed = 1</code>。</p>
</blockquote>
<p>这是在用户态写入的情况。还有一种情况是在内核态向用户空间写入数据，那就是 <code>copyout()</code> 函数。同样的，如果遇到一个虚拟地址对应页表项的 <code>PTE_COW</code> 被置 1，说明这一页要在写入时进行拷贝，那流程跟上面基本是一样的，只不过遇到没有空闲内存而导致分配页失败后直接 <code>return -1</code> 即可。</p>
<p>到这里就够了吗？还不够。因为还有一个关键问题我们没有解决，那就是父子进程中的如果都使用 COW 分配新页并修改页表项后，原来的那个页面将没有任何页表项指向——内存泄漏产生了。本质原因在于现有的机制没法意识到一个页面什么时候该被释放，一个合理的措施是维护所有页面的「<strong>引用计数</strong>」，每当一个页面被一个页表项指向时，调用 <code>pin()</code> 将其计数值加一，同样的，每当一个页表项取消指向时，调用 <code>unpin()</code> 将其计数值减一，而减到 0 后就调用 <code>kfree</code> 进行释放。这样一来就解决了内存泄漏的问题。这样就需要把原本对 <code>kfree</code> 的调用统一替换为 <code>unpin()</code>。</p>
<blockquote>
<p>分配一个页面时，其引用计数自动设为 1。</p>
</blockquote>
<p>引用计数能做的事情很多，比如当某一进程写入 COW 页却发现这一页的引用计数只有 1 时，它会意识到这一页被自己<strong>独占</strong>，那就不需要进行新页的分配了，直接修改页表项的标志位即可。</p>
<p>lab 手册提示我们可以将引用计数实现为一个数组，定义在 <code>kernel/kalloc.c</code> 中。那么数组有多大呢？毕竟我们是通过页号进行索引的，那么数组大小就是可用页数，通过查看 <code>kernel/riscv.h</code> 我们发现了两个宏，<code>KERNBASE</code> 与 <code>PHYSTOP</code>，这两值之差便是整个可用内存空间大小，再除以 <code>PGSIZE</code> 那就是可用页数了。</p>
<p>数组大小确定了，那么索引方式也很快能想到，直接 <code>(pa - KERNBASE) &gt;&gt; 12</code> 即可。虽然前面可能有部分页会被浪费，但胜在简单可靠。</p>
<p>思路捋清了，那代码就很好写了。</p>
<h2 id="Preparation"><a class="header-anchor" href="#Preparation">#</a>Preparation</h2>
<p>切换到对应分支</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> fetch
$ <span class="token function">git</span> checkout cow
$ <span class="token function">make</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="Task-Implement-copy-on-write"><a class="header-anchor" href="#Task-Implement-copy-on-write">#</a>Task: Implement copy-on write</h2>
<h3 id="引用计数"><a class="header-anchor" href="#引用计数">#</a>引用计数</h3>
<p>首先实现引用计数。</p>
<pre class="line-numbers language-C" data-language="C"><div class="caption"><span>kernel/kalloc.c</span></div><code class="language-C">#define NPAGES (PHYSTOP-KERNBASE)/PGSIZE

static uint8 ref_count[NPAGES];

// arg start_pa must be PGROUNDed
uint64
page_idx(void* start_pa)
{
  uint64 idx = ((uint64)start_pa-KERNBASE) &gt;&gt; 12;
  if (idx &gt;= NPAGES) {
    return -1;
  }
  return idx;
}

// plus the reference count of page at pa
void
pin(void* pa)
{
  void* start_pa = (void*)PGROUNDDOWN((uint64)pa);
  uint64 idx = page_idx(start_pa);
  if (idx == -1) {
    panic("invalid page\n");
  }

  ref_count[idx]++;
}

// minus the reference count of page at pa
// if the count is 0 after unpin, free it
void
unpin(void* pa)
{
  void* start_pa = (void*)PGROUNDDOWN((uint64)pa);
  uint64 idx = page_idx(start_pa);
  if (idx == -1) {
    panic("invalid page\n");
  }

  if (--ref_count[idx] == 0) {
    kfree(start_pa);
  }
}

uint8
getcount(void* pa)
{
  void* start_pa = (void*)PGROUNDDOWN((uint64)pa);
  uint64 idx = page_idx(start_pa);
  if (idx == -1) {
    panic("invalid page\n");
  }
  return ref_count[idx];
}

int
pinned(void* pa)
{
  return getcount(pa) &gt; 0;
}

int
exown(void* pa)
{
  return getcount(pa) == 1;
}

void
kinit()
{
  initlock(&amp;kmem.lock, "kmem");
  memset(ref_count, 0, sizeof(ref_count));   // (!new)
  freerange(end, (void*)PHYSTOP);
}

// Allocate one 4096-byte page of physical memory.
// Returns a pointer that the kernel can use.
// Returns 0 if the memory cannot be allocated.
void *
kalloc(void)
{
  struct run *r;

  acquire(&amp;kmem.lock);
  r = kmem.freelist;
  if(r)
    kmem.freelist = r-&gt;next;
  release(&amp;kmem.lock);

  if(r){
    memset((char*)r, 5, PGSIZE);
    pin((void*)r);   // (!new)
  }
  return (void*)r;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了在其他文件中调用，部分函数需要在 <code>def.h</code> 中添加声明。</p>
<h3 id="uvmcopy"><a class="header-anchor" href="#uvmcopy">#</a>uvmcopy()</h3>
<pre class="line-numbers language-C" data-language="C"><div class="caption"><span>kernel/vm.c</span></div><code class="language-C">int
uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)
{
  pte_t *pte;
  uint64 pa, i;
  uint flags;

  for(i = 0; i &lt; sz; i += PGSIZE){
    if ((pte = walk(old, i, 0)) == 0)
      panic("uvmcopy: pte should exist");
    if ((*pte &amp; PTE_V) == 0)
      panic("uvmcopy: page not present");

    pa = PTE2PA(*pte);
    *pte &amp;= ~PTE_W;   // clear PTE_W
    *pte |= PTE_COW;  // add PTE_COW

    flags = PTE_FLAGS(*pte);
    if (mappages(new, i, PGSIZE, pa, flags) != 0) {
      uvmunmap(new, 0, i / PGSIZE, 0);
      return -1;
    }

    pin((void*)pa); // !!!很重要
  }
  return 0;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="usertrap"><a class="header-anchor" href="#usertrap">#</a>usertrap()</h3>
<pre class="line-numbers language-C" data-language="C"><div class="caption"><span>kernel/trap.c</span></div><code class="language-C">void
usertrap(void)
{
  ...
  if(r_scause() == 8){
    ...
  } else if (r_scause() == 15) {
    if(p-&gt;killed)
      exit(-1);

    uint64 start_va = PGROUNDDOWN(r_stval());
    if (start_va &gt;= MAXVA) // walk 前检查一下，避免 panic 导致测试卡住
      exit(-1);

    pte_t* pte = walk(p-&gt;pagetable, start_va, 0);
    if (pte == 0 || (*pte &amp; PTE_V) == 0 || (*pte &amp; PTE_U) == 0 || (*pte &amp; PTE_COW) == 0)
      panic("invalid pte");

    uint64 pa = PTE2PA(*pte);
    if (exown((void*)pa)) { // 如果独占，只需修改标志位，无需拷贝，省时省力
      *pte &amp;= ~PTE_COW;
      *pte |= PTE_W;
    } else {
      char* npa = (char*)kalloc();
      if(npa == 0){
        // 如果没有可用内存，杀掉进程
        acquire(&amp;p-&gt;lock);
        p-&gt;killed = 1;
        release(&amp;p-&gt;lock);
      } else {
        memmove(npa, (char*)pa, PGSIZE);

        *pte &amp;= ~PTE_COW;
        *pte |= PTE_W;
        *pte = PTE_FLAGS(*pte) | PA2PTE(npa);

        unpin((void*)pa);
      }
    }
  }
  ...
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="copyout"><a class="header-anchor" href="#copyout">#</a>copyout()</h3>
<pre class="line-numbers language-C" data-language="C"><div class="caption"><span>kernel/vm.c</span></div><code class="language-C">int
copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)
{
  pte_t *pte;
  uint64 n, va0, pa0;
  while(len &gt; 0){
    va0 = PGROUNDDOWN(dstva);
    if (va0 &gt;= MAXVA) // walk 前检查一下，避免 panic 导致测试卡住
      return -1;

    pte = walk(pagetable, va0, 0);
    if (pte == 0 || (*pte &amp; PTE_V) == 0 || (*pte &amp; PTE_U) == 0)
      return -1;

    pa0 = PTE2PA(*pte);
    if (*pte &amp; PTE_COW) {
      if (exown((void*)pa0)) {
        *pte &amp;= ~PTE_COW;
        *pte |= PTE_W;
      } else {
        char* npa = (char*)kalloc();
        if(npa){
          memmove(npa, (char*)pa0, PGSIZE);

          *pte &amp;= ~PTE_COW;
          *pte |= PTE_W;
          *pte = PTE_FLAGS(*pte) | PA2PTE(npa);

          unpin((void*)pa0);
        }
        pa0 = (uint64)npa;  // 如果 npa 为 0，则最终会 return -1
                            // 反之，npa 成为新的 pa0，即 dst pa
      }
    }

    if(pa0 == 0)
      return -1;
    ...
  }
  return 0;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="测试结果"><a class="header-anchor" href="#测试结果">#</a>测试结果</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">make</span> grade
<span class="token punctuation">..</span>.
<span class="token operator">==</span> Test running cowtest <span class="token operator">==</span>
$ <span class="token function">make</span> qemu-gdb
<span class="token punctuation">(</span><span class="token number">6</span>.8s<span class="token punctuation">)</span>
<span class="token operator">==</span> Test   simple <span class="token operator">==</span>
  simple: OK
<span class="token operator">==</span> Test   three <span class="token operator">==</span>
  three: OK
<span class="token operator">==</span> Test   <span class="token function">file</span> <span class="token operator">==</span>
  file: OK
<span class="token operator">==</span> Test usertests <span class="token operator">==</span>
$ <span class="token function">make</span> qemu-gdb
<span class="token punctuation">(</span><span class="token number">116</span>.5s<span class="token punctuation">)</span>
<span class="token operator">==</span> Test   usertests: copyin <span class="token operator">==</span>
  usertests: copyin: OK
<span class="token operator">==</span> Test   usertests: copyout <span class="token operator">==</span>
  usertests: copyout: OK
<span class="token operator">==</span> Test   usertests: all tests <span class="token operator">==</span>
  usertests: all tests: OK
<span class="token operator">==</span> Test <span class="token function">time</span> <span class="token operator">==</span>
time: OK
Score: <span class="token number">110</span>/110<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="最后的工作"><a class="header-anchor" href="#最后的工作">#</a>最后的工作</h2>
<ol>
<li class="lvl-3">
<p><code>git commit -am ""</code> 将所有修改提交到本地;</p>
</li>
<li class="lvl-3">
<p>执行 <code>make handin</code>。由于 lab0 保存了 APIKey，故直接成功提交；</p>
</li>
</ol>
<p>可选的挑战再说吧，没有什么想做的欲望。</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">这个人太懒了，都不想加标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/lab/6-s081lab5/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="6.s081 Lab5 Multithreading">
                        
                        <span class="card-title">6.s081 Lab5 Multithreading</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            现在进入操作系统的另一大特性：并发。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-10-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category">
                                    Lab
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/lab/6-s081lab3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="6.s081 Lab3 Traps">
                        
                        <span class="card-title">6.s081 Lab3 Traps</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            现在是，陷入内核时间。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-10-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Lab/" class="post-category">
                                    Lab
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2023-2025</span>
            
            <a href="/about" target="_blank">Leager</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
                <span id="translate">|&nbsp;繁/简：</span><a id="translateLink" href="javascript:translatePage();">繁</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2023";
                        var startMonth = "8";
                        var startDate = "1";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Leager-zju" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1004729740@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1004729740" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1004729740" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
        <script type="text/javascript" src="/js/tw_cn.js"></script>
        <script type="text/javascript">
          var defaultEncoding = 2; //网站编写字体是否繁体，1-繁体，2-简体
          var translateDelay = 0; //延迟时间,若不在前, 要设定延迟翻译时间, 如100表示100ms,默认为0
          var cookieDomain = "http://Leager-zju.github.io"; //Cookie地址, 一定要设定, 通常为你的网址
          var msgToTraditionalChinese = "繁"; //此处可以更改为你想要显示的文字
          var msgToSimplifiedChinese = "简"; //同上，但两处均不建议更改
          var translateButtonId = "translateLink"; //默认互换id
          translateInitilization();
        </script>
    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

    <script type="text/javascript">
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                document.title = '你会有一天后悔';
            } else {
                document.title = '欢迎来到 G8 北海道 洞爷湖 高峰会 博物馆';
            }
        });
    </script>

</body>

</html>
