---
title: C++ ã® å†…å­˜åˆ†é…(Memory Allocation)
author: Leager
mathjax: true
date: 2023-02-19 14:07:28
summary:
categories: C++
tags: C++ Basic
img:
---

ä¼—æ‰€å‘¨çŸ¥ï¼ŒC++ æ˜¯ä¸€é—¨ä¸å†…å­˜ç´§å¯†ç›¸å…³çš„è¯­è¨€ï¼Œæœ¬æ–‡å°±æ¥èŠèŠ C++ çœ¼ä¸­çš„**å†…å­˜åˆ†é…**ã€‚

<!--more-->

## å†…å­˜å¸ƒå±€

C++ ç¨‹åºçš„å†…å­˜åˆ†ä¸º 5 å¤§åŒºåŸŸï¼Œåˆ†åˆ«ä¸º**ä»£ç åŒº**ã€**å¸¸é‡å­˜å‚¨åŒº**ã€**å…¨å±€/é™æ€å­˜å‚¨åŒº**ã€**å †åŒº**ã€**æ ˆåŒº**ï¼Œæ¯ä¸ªåŒºåŸŸå­˜æ”¾ä¸åŒç±»å‹çš„æ•°æ®ï¼š

- **ä»£ç åŒº(.text)**ï¼šå­˜æ”¾å¯æ‰§è¡Œç¨‹åº(.exe)çš„æœºå™¨ç ï¼›

- **å¸¸é‡å­˜å‚¨åŒº(.rodata)**ï¼šå­˜æ”¾**å¸¸é‡**ï¼Œä¸å…è®¸ä¿®æ”¹ï¼›

- **å…¨å±€/é™æ€å­˜å‚¨åŒº(.bss/.data)**ï¼š**å…¨å±€å˜é‡**ä¸**é™æ€å˜é‡**è¢«åˆ†é…åˆ°åŒä¸€ç‰‡å†…å­˜ï¼›

    > C é‡Œä¼šæ ¹æ®å˜é‡åˆå§‹åŒ–ä¸å¦ç»†åˆ†ä¸º data å’Œ bssï¼Œbut C++ notã€‚

- **å †åŒº(heap)**ï¼šé€šè¿‡åº“å‡½æ•° `malloc()` åŠ¨æ€åˆ†é…çš„æ•°æ®æ‰€åœ¨å¤„ï¼Œåœ°å€ä»ä½å‘é«˜å¢é•¿ã€‚å¦‚æœå †åŒºæŸç‰‡å†…å­˜æ²¡æœ‰é€šè¿‡ `free()` é‡Šæ”¾ï¼Œåˆ™åœ¨ç¨‹åºç»“æŸåç”±æ“ä½œç³»ç»Ÿè‡ªåŠ¨å›æ”¶ï¼Œä½†å¦‚æœä¸åŠæ—¶é‡Šæ”¾ï¼Œé‚£ä¹ˆåç»­å¾ˆå¯èƒ½æ— æ³•åˆ†é…åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼›

    > C++ é‡Œæœ‰ä¸ªæ¦‚å¿µå«**è‡ªç”±å­˜å‚¨åŒº**ï¼Œä¸“æŒ‡é€šè¿‡è¿ç®—ç¬¦ `new` åˆ†é…å¾—åˆ°çš„å†…å­˜åŒºåŸŸã€‚å½“ä½¿ç”¨é»˜è®¤ `new` æ—¶ï¼Œä¼šåˆ†é…å †åŒºçš„å†…å­˜ï¼Œæ­¤æ—¶è‡ªç”±å­˜å‚¨åŒº=å †åŒºï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè¿ç®—ç¬¦é‡è½½ï¼Œæ”¹ç”¨å…¶ä»–å†…å­˜æ¥å®ç°è‡ªç”±å­˜å‚¨ï¼Œä¾‹å¦‚å…¨å±€å˜é‡åšçš„å¯¹è±¡æ± ï¼Œè¿™æ ·è‡ªç”±å­˜å‚¨åŒºå°±ä¸ä¸€å®šæ˜¯å †åŒºäº†ã€‚æ‰€ä»¥è¯´æ˜¯**è‡ªç”±**å˜›(
    >
    > æ€»è€Œè¨€ä¹‹ï¼Œå †åŒºæ˜¯æ“ä½œç³»ç»Ÿç»´æŠ¤çš„ä¸€å—å†…å­˜ï¼Œè€Œè‡ªç”±å­˜å‚¨åŒºæ˜¯ C++ ä¸­é€šè¿‡ `new` ä¸ `delete` åŠ¨æ€åˆ†é…å’Œé‡Šæ”¾å¯¹è±¡çš„æŠ½è±¡æ¦‚å¿µï¼Œä¸å †å¹¶ä¸ç­‰ä»·ã€‚

- **æ ˆåŒº(stack)**ï¼šç¨‹åºå±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°å€¼ã€å‡½æ•°è¿”å›å€¼æ‰€åœ¨å¤„ï¼Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç®¡ç†åˆ†é…ï¼Œåœ°å€ä»é«˜å‘ä½å¢é•¿ï¼›

## å†…å­˜åˆ†é… in C

åœ¨ C ä¸­ï¼Œä½¿ç”¨ `alloc()` ç³»åº“å‡½æ•°æ¥è¿›è¡Œå†…å­˜çš„åŠ¨æ€åˆ†é…ã€‚

### malloc()

```c++
void* malloc( std::size_t size );
```

åˆ†é…ä¸€ç‰‡è¿ç»­çš„ `size` ä¸ªå­—èŠ‚çš„**æœªåˆå§‹åŒ–**å­˜å‚¨ã€‚æˆåŠŸæ—¶ï¼Œè¿”å›æŒ‡å‘åˆ†é…çš„é€‚åˆå¯¹ä»»ä½•æ ‡é‡ç±»å‹å¯¹é½çš„å†…å­˜å—ä¸­ï¼Œæœ€ä½ï¼ˆé¦–ï¼‰å­—èŠ‚çš„æŒ‡é’ˆï¼›åä¹‹ï¼Œè¿”å›ç©ºæŒ‡é’ˆã€‚

> ä½¿ç”¨æ—¶éœ€å¼ºè½¬ä¸ºæ‰€éœ€ç±»å‹çš„æŒ‡é’ˆã€‚

ğŸ”” è°ƒç”¨ `malloc` åˆ†é…å†…å­˜æ—¶ï¼Œä¼šæœ‰ä¸¤ç§æ–¹å¼å‘æ“ä½œç³»ç»Ÿç”³è¯·

1. å°äºæŸä¸ªé˜ˆå€¼ï¼ˆå¦‚ 128KBï¼‰æ—¶ï¼Œä½¿ç”¨ `brk()` ç³»ç»Ÿè°ƒç”¨åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼›
2. å¤§äºæŸä¸ªé˜ˆå€¼æ—¶ï¼Œä½¿ç”¨ `mmap()` ç³»ç»Ÿè°ƒç”¨åœ¨æ–‡ä»¶æ˜ å°„åŒºä¸Šåˆ†é…å†…å­˜ï¼›

### calloc()

```c++
void* calloc( std::size_t num, std::size_t size );
```

åˆ†é… `num` ä¸ªå¤§å°ä¸º `size` çš„å¯¹è±¡çš„æ•°ç»„ï¼Œå¹¶**åˆå§‹åŒ–**æ‰€æœ‰ bit ä¸ºé›¶ã€‚æˆåŠŸæ—¶ï¼Œè¿”å›æŒ‡å‘ä¸ºä»»ä½•å¯¹è±¡ç±»å‹é€‚å½“å¯¹é½çš„ï¼Œè¢«åˆ†é…å†…å­˜å—æœ€ä½ï¼ˆé¦–ï¼‰å­—èŠ‚çš„æŒ‡é’ˆï¼›åä¹‹ï¼Œè¿”å›ç©ºæŒ‡é’ˆã€‚

> ç›¸å½“äºåˆå§‹åŒ– + `malloc(num * size);`

### realloc()

```c++
void* realloc( void* ptr, std::size_t new_size );
```

é‡åˆ†é…ï¼ˆæ‰©å¼ æˆ–æ”¶ç¼©ï¼‰ç»™å®šçš„å†…å­˜åŒºåŸŸ `ptr` å¤§å°è‡³ `new_size`ã€‚æ³¨æ„è¿™é‡Œçš„å†åˆ†é…ä¸ä¸€å®šåœ¨åŸåŒºåŸŸçš„åŸºç¡€ä¸Šï¼Œè€Œæœ‰å¯èƒ½é‡æ–°åˆ†é…ä¸€ç‰‡æ–°ç©ºé—´ã€‚æˆåŠŸæ—¶ï¼Œè¿”å›æŒ‡å‘æ–°åˆ†é…å†…å­˜èµ·å§‹çš„æŒ‡é’ˆï¼›åä¹‹ï¼Œè¿”å›ç©ºæŒ‡é’ˆï¼Œä¸”åŸæŒ‡é’ˆä¿ç•™ã€‚

> å®ƒå¿…é¡»æ˜¯ `malloc()`ã€ `calloc()` æˆ– `realloc()` å…ˆå‰åˆ†é…çš„ï¼Œä¸”ä»æœªè¢« `free()` é‡Šæ”¾ï¼Œå¦åˆ™ UBã€‚

### free()

```c++
void free( void* ptr );
```

ä¸ `alloc` ç³»æ­é…ä½¿ç”¨ï¼Œç”¨äºæ‰‹åŠ¨é‡Šæ”¾åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç©ºé—´ã€‚

- è‹¥ `ptr` ä¸ºç©ºæŒ‡é’ˆï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼›
- è‹¥ `ptr` å¹¶æœªæŒ‡å‘ç» `alloc` åŠ¨æ€åˆ†é…çš„ç©ºé—´ï¼Œåˆ™ä¸º UBï¼›
- å¯¹åŒä¸€ä¸ª `ptr` å¤šæ¬¡ `free` çš„è¡Œä¸ºä¸º UBï¼›
- å¯¹å·² `free` çš„ `ptr` è¿›è¡Œå†…å­˜è®¿é—®ï¼Œä¸º UBï¼›

æ³¨æ„ï¼Œ`free` ä»…ä»…æ˜¯é‡Šæ”¾äº†æŒ‡é’ˆæŒ‡å‘çš„é‚£ç‰‡å†…å­˜ï¼Œå¹¶æ²¡æœ‰æ”¹å˜æŒ‡é’ˆçš„æŒ‡å‘ï¼Œä½† `free` ä¹‹åå†æ¬¡ä½¿ç”¨æŒ‡é’ˆæ˜¯ä¸åˆç†çš„ï¼Œåº”å½“ç½®ç©ºã€‚

```c++
int* ptr = (int*)malloc(sizeof(int));
printf("before free: %p\n", ptr);

free(ptr);
printf("after free: %p\n", ptr); // WARNING!

ptr = NULL;                      // nullptr in C++

// output:
// before free: 000001EF641FCFB0
// after free: 000001EF641FCFB0
```

## å†…å­˜åˆ†é… in C++

è€Œåœ¨ C++ ä¸­ï¼Œç”±äºå¼•å…¥äº†**ç±»**è¿™ä¸€æ¦‚å¿µï¼Œ`alloc` / `free` è¿™ç§åªèƒ½åˆ†é…/é‡Šæ”¾å†…å­˜çš„å‡½æ•°å¹¶ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚â€”â€”`alloc` åˆ†é…å†…å­˜æ—¶å¹¶ä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å¦‚æœ `free` ç®€å•åœ°é‡Šæ”¾äº†ä¸€ä¸ªç±»å¯¹è±¡çš„å†…å­˜ï¼Œé‚£ä¹ˆå…¶ææ„å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨ï¼Œè¿™æä¸å¥½ä¼šå¼•å‘å¤§ç¾éš¾ã€‚äºæ˜¯ï¼Œå®ƒä¿©è¢«åŠŸèƒ½æ›´å¼ºå¤§çš„ `new` / `delete` æ‰€å–ä»£ã€‚

### new / delete

> å®šä¹‰äºå¤´æ–‡ä»¶ `<new>`

```c++
::(opt) new (å¸ƒç½®å‚æ•°)(opt) (ç±»å‹) åˆå§‹åŒ–å™¨(opt) ;

int* p1 = new int (1);  // p1 æŒ‡å‘ int å˜é‡ï¼Œå¹¶åˆå§‹åŒ–ä¸º 1
int* p2 = new int[2] {114, 514};  // p2 æŒ‡å‘æ•°ç»„ int[2]ï¼Œå¹¶åˆå§‹åŒ–ä¸º {114, 514}
int* p3 = new(p1) int (3);        // å®šä½ newï¼Œä¸éœ€è¦é¢å¤–åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯ç›´æ¥åœ¨å·²åˆ†é…çš„å†…å­˜(p1)å¤„è°ƒç”¨æ„é€ å‡½æ•°å³å¯
int* p4 = new (std::nothrow) int{4}; // åˆ†é…å¤±è´¥æ—¶ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯è¿”å› nullptr
std::cout << *p1 << " " << p2[0] << " " << p2[1] << " " << *p3 << " " << *p4;

delete p1;    // å•å˜é‡ç”¨ delete
delete[] p2;  // æ•°ç»„ç”¨ delete[]
delete p3;
delete p4;

// output: 3 114 514 3 4
```

`new` / `new[]` ä¸»è¦å®Œæˆä¸¤ä»¶äº‹ï¼š

1. åº•å±‚ `operator new()` è°ƒç”¨ `malloc()` åŠ¨æ€åˆ†é…å†…å­˜ï¼›
2. åœ¨åˆ†é…çš„åŠ¨æ€å†…å­˜å—ä¸Šè°ƒç”¨æ„é€ å‡½æ•°ä»¥åˆå§‹åŒ–å¯¹è±¡ã€‚æˆåŠŸæ—¶è¿”å›é¦–åœ°å€ï¼Œå¦åˆ™æŠ›å‡º `std::bad_alloc()` å¼‚å¸¸ï¼ˆå¯ä»¥é€šè¿‡åŠ  `std::nothrow` æ”¹å˜ï¼‰ï¼›

`delete` / `delete[]` ä¹Ÿä¸»è¦å®Œæˆä¸¤ä»¶äº‹ï¼š

1. è°ƒç”¨ææ„å‡½æ•°ï¼›
2. åº•å±‚ `operator delete()` é‡Šæ”¾å†…å­˜ï¼›

### å®šä½ new(placement new)

ä¸Šé¢çš„ä»£ç æåˆ°äº†ä¸€ç§å«**å®šä½ new** çš„æ“ä½œï¼Œå®ƒçš„æ„ä¹‰åœ¨äºå°†å†…å­˜çš„**åˆ†é…å’Œæ„é€ åˆ†ç¦»**ã€‚

> å¦‚æœå†…å­˜åˆ†é…ä¸æ„é€ ä¸åˆ†ç¦»ï¼Œåˆ™å­˜åœ¨ä»¥ä¸‹å¼Šç«¯ï¼š
>
> 1. å¯èƒ½ä¼šæ„é€ å‡ºæˆ‘ä»¬ç”¨ä¸åˆ°çš„å¯¹è±¡ï¼›
> 2. åˆå§‹åŒ–ä¸åç»­ä½¿ç”¨æ—¶å„è¿›è¡Œä¸€æ¬¡èµ‹å€¼ï¼Œäº§ç”Ÿä¸å¿…è¦çš„å¼€é”€ï¼›
>
> > ```c++
> > auto ptr = new Foo[10]; // é»˜è®¤åˆå§‹åŒ–èµ‹å€¼ä¸€æ¬¡
> > for (int i = 0; i < 10; i++) {
> >   Foo[i] = {...};       // åç»­åˆè¿›è¡Œäº†ä¸€æ¬¡èµ‹å€¼
> > }
> > ```
>
> 3. æ²¡æœ‰é»˜è®¤åˆå§‹åŒ–å‡½æ•°çš„ç±»ç”šè‡³æ‰§è¡Œä¸äº† `new[]` æ“ä½œï¼›

è€Œå€ŸåŠ©å®šä½ new æ¥è¿›è¡Œå¯¹è±¡çš„æ„å»ºï¼Œä¸Šè¿°å¼Šç«¯åˆ™è¿åˆƒè€Œè§£ï¼šä¸€æ–¹é¢å¯ä»¥é¿å…é¢‘ç¹è°ƒç”¨ç³»ç»Ÿ `new` / `delete` å¸¦æ¥çš„å¼€é”€ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥æ‰‹åŠ¨æ§åˆ¶å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ä»¥åŠç±»çš„æ„é€ ï¼Œæ›´åŠ è‡ªç”±ã€‚

> ä½¿ç”¨æ­¤æ³•ï¼Œåˆ™ä¸ä¸€å®šä¼šåœ¨**å †**ä¸Šåˆ†é…å†…å­˜ï¼Œè€Œæ˜¯åœ¨å¯¹åº”åœ°å€å¤„ç›´æ¥æ„é€ ã€‚

### é‡è½½ operator new()

`new` / `delete` æ˜¯å…³é”®å­—ï¼Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹å…¶åŠŸèƒ½æœ¬èº«ï¼Œä½†å…¶åº•å±‚æ‰€ä½¿ç”¨çš„è¿ç®—ç¬¦ `operator new()` / `operator delete()` åˆ™èƒ½ä¸ºæˆ‘ä»¬æ ¹æ®éœ€è¦æ‰€é‡è½½ä½¿ç”¨ã€‚

```c++
class Foo {
 public:
  void* operator new(size_t size) {
    std::cout << "operator new override\n";
    return std::malloc(size);
  }
};

int main() {
  Foo* f = new Foo;
  delete f;
}
// output: operator new override
```

é‡åˆ° `new Foo` æ—¶ï¼Œç¼–è¯‘å™¨é¦–å…ˆåœ¨ç±»å’Œå…¶åŸºç±»ä¸­å¯»æ‰¾ `operator new()`ï¼Œæ‰¾ä¸åˆ°å°±åœ¨å…¨å±€ä¸­æ‰¾ï¼Œå†æ‰¾ä¸åˆ°å°±ç”¨é»˜è®¤çš„ã€‚æˆ‘ä»¬åœ¨ç±»ä¸­é‡è½½äº†è¯¥æ“ä½œç¬¦ï¼Œä¸”å¯¹æ“ä½œç¬¦çš„é‡è½½é»˜è®¤ä¸º `static`ï¼Œäºæ˜¯åº•å±‚ä¼šè°ƒç”¨ `Foo::operator new() (sizeof(Foo));`

å½“ç„¶ï¼Œé‡è½½å½¢å¼ä¹Ÿå¯ä»¥åŠ å…¥æ›´å¤šå‚æ•°ï¼Œä½†ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸º `size_t` ç±»å‹ï¼Œä¸”è¿”å›å€¼å¿…é¡»ä¸º `void*` ç±»å‹ã€‚æ¯”å¦‚ä¸Šé¢è¯´çš„å®šä½ newï¼Œå°±æ˜¯åœ¨å‚æ•°åˆ—è¡¨ä¸­åŠ äº†ä¸€ä¸ª `void*` çš„é‡è½½å½¢å¼ã€‚

```c++
class Foo {
 public:
  void* operator new(size_t size, void* ptr) {
    std::cout << "placement new override\n";
    return ptr;
  }
};

int main() {
  Foo* temp = new Foo;
  Foo* f = new (temp) Foo;
  delete temp;
  // delete f;
}
// output: placement new override
```

ç›¸å½“äºåº•å±‚è°ƒç”¨äº†  `Foo::operator new() (sizeof(Foo), temp);`ã€‚æ­¤æ—¶å°±ä¸ç”¨å† `delete f` äº†ï¼Œæ‡‚å¾—éƒ½æ‡‚ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥åŠ åˆ«çš„å½¢å‚ï¼Œæ¯”å¦‚ `void* operator new(size_t, int);`ï¼Œä½¿ç”¨æ—¶ç›´æ¥ `new(100) type;` å³å¯ï¼ˆåœ†æ‹¬å·é‡Œå°±æ˜¯ä»é™¤äº† `size_t` ä»¥å¤–çš„å®å‚åˆ—è¡¨ï¼‰ã€‚ä¹‹å‰æåˆ°çš„åŠ ä¸Š `std::nothrow` ä¸ä¼šæŠ›å‡ºå¼‚å¸¸åˆ™æ˜¯ä½¿ç”¨äº† `void* opertor new(size_t, nothrow_t&)` çš„é‡è½½å½¢å¼ã€‚

### é‡è½½ operator delete()

é‡è½½ `operator delete()` æ—¶éœ€æ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸º `void*`ï¼Œä¸”è¿”å›å€¼å¿…é¡»ä¸º `void`ã€‚ä½†å¹¶æ²¡æœ‰é‡è½½çš„å¿…è¦ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•æ‰‹åŠ¨è°ƒç”¨ã€‚ä½†è®¾ç½®è¿™ä¸ªçš„æ„ä¹‰åœ¨äºä¸ `operator new()` é…å¥—ä½¿ç”¨ï¼Œåªæœ‰ `operator new` æŠ›å¼‚å¸¸äº†ï¼Œæ‰ä¼šè°ƒç”¨å¯¹åº”çš„ `operator delete`ã€‚è‹¥æ²¡æœ‰å¯¹åº”çš„ `operator delete`ï¼Œåˆ™æ— æ³•é‡Šæ”¾å†…å­˜ã€‚

### å…¶ä»–

#### delete this åˆæ³•å—ï¼Ÿ

åˆæ³•ï¼Œä½†å¿…é¡»ä¿è¯ï¼š

1. this å¯¹è±¡æ˜¯é€šè¿‡ `new` åœ¨å †ä¸Šåˆ†é…çš„ï¼›
2. `delete this` åæ²¡æœ‰äººä½¿ç”¨è¯¥å¯¹è±¡/è°ƒç”¨ this äº†ï¼Œä½¿ç”¨æˆå‘˜å˜é‡/æˆå‘˜å‡½æ•°ä¹Ÿä¸è¡Œï¼›

    > å†…å­˜éƒ½æ²¡äº†è¿˜è°ƒç”¨ä¸ª der

#### å¦‚ä½•å®šä¹‰ä¸€ä¸ªåªèƒ½åœ¨å †/æ ˆä¸Šç”Ÿæˆå¯¹è±¡çš„ç±»ï¼Ÿ

- **åªèƒ½åœ¨å †ä¸Š**ï¼šå°†ææ„å‡½æ•°è®¾ç½®ä¸º**éå…¬æœ‰**ã€‚C++ æ˜¯é™æ€ç»‘å®šè¯­è¨€ï¼Œç¼–è¯‘å™¨ç®¡ç†æ ˆä¸Šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¼–è¯‘å™¨åœ¨ä¸ºç±»å¯¹è±¡åˆ†é…æ ˆç©ºé—´æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥ç±»çš„ææ„å‡½æ•°çš„è®¿é—®æ€§ã€‚è‹¥ææ„å‡½æ•°ä¸å¯è®¿é—®ï¼Œåˆ™ä¸èƒ½åœ¨æ ˆä¸Šåˆ›å»ºå¯¹è±¡ã€‚

    ```c++
    // Bad Example â†’_â†’
    // can't derive and inconvenient
    class Foo {
     private:
      ~Foo() = default;
     public:
      void Destory() {
        Foo::~Foo(); // or delete this;
      }
    }

    // Good Example ^_^
    class Bar {
     protected:
      Bar() = default;
      ~Bar() = default;
     public:
      static Bar* GetBar() {
        return new Bar;
      }
      void Destory() {
        delete this;
      }
    };
    ```

- **åªèƒ½åœ¨æ ˆä¸Š**ï¼šå°† `operator new()` å’Œ `operator delete()` è®¾ç½®ä¸º**ç§æœ‰**ã€‚æ­¤æ—¶ `new` çš„ç¬¬ä¸€æ­¥æ“ä½œï¼ˆä¸Šé¢è®²è¿‡ï¼‰æ— æ³•æ‰§è¡Œï¼Œè¿›è€Œæ— æ³•åœ¨å †ä¸Šç”Ÿæˆã€‚

#### ä¸ºä»€ä¹ˆè¯´ new æ•ˆç‡ä½

`new` çš„åŠ¨æ€åˆ†é…å†…å­˜æ¶‰åŠåˆ°å†…æ ¸çº§è¡Œä¸ºï¼Œå¹¶ä¸”å­˜åœ¨ä¸Šé”çš„å¯èƒ½ï¼Œä¼šäº§ç”Ÿä¸€å®šå¼€é”€ã€‚è¿›è¡Œåˆ†é…æ—¶ï¼Œå¦‚æœä¸æ˜¯å®šä½ newï¼Œåˆ™ä¼šåœ¨ä»»æ„ä½ç½®è¿›è¡Œåˆ†é…ï¼Œä¸æ˜“ç®¡ç†ã€‚

## åˆ†é…å™¨ Allocator

> å®šä¹‰äºå¤´æ–‡ä»¶ `<memory>`

C++ çš„æ‰€æœ‰å®¹å™¨éƒ½æ˜¯ç±»æ¨¡æ¿ï¼Œä»¥ `std::vector` ä¸ºä¾‹ï¼Œå…¶åœ¨å®šä¹‰ä¸­åŒ…å«äº†ä¸¤ä¸ªæ¨¡æ¿å‚æ•°ã€‚
```c++
template<
    class T,
    class Allocator = std::allocator<T>
>
```
ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å®¹å™¨åŒ…å«çš„å…ƒç´ ç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ä¸‹é¢è¦è®²çš„**åˆ†é…å™¨ç±»**ï¼Œé»˜è®¤ä¸º C++ è‡ªå¸¦çš„ `std::allocator`ã€‚

æ‰€è°“**åˆ†é…å™¨**ï¼Œå°±æ˜¯è´Ÿè´£å°è£…å †å†…å­˜ç®¡ç†çš„å¯¹è±¡ï¼Œå®ƒä»¬åœ¨æ•´ä¸ªæ ‡å‡†åº“ä¸­ä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯ STL å®¹å™¨ä½¿ç”¨å®ƒä»¬æ¥ç®¡ç†å®¹å™¨å†…éƒ¨çš„æ‰€æœ‰å†…å­˜åˆ†é…ã€‚å…¶æœ€å¤§çš„ç‰¹ç‚¹ä¸æ„ä¹‰åœ¨äºï¼Œå°†å†…å­˜åˆ†é…ä¸æ„é€ åˆ†ç¦»ï¼ˆæ­£å¦‚å®šä½ new é‚£æ ·ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥å…ˆåˆ†é…å¤§å—å†…å­˜ï¼Œè€Œåªåœ¨çœŸæ­£éœ€è¦æ—¶æ‰æ‰§è¡Œå¯¹è±¡åˆ›å»ºæ“ä½œã€‚

`std::allocator` çš„æˆå‘˜å‡½æ•°å¦‚ä¸‹ï¼š

> C++20 å¯¹åˆ†é…å™¨çš„æˆå‘˜å‡½æ•°è¿›è¡Œäº†ä¸€äº›æ”¹åŠ¨

- `constexpr T* allocate(size_t n)`ï¼šåˆ†é…è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´æ¥å­˜å‚¨ n ä¸ªå®ä¾‹ï¼Œå¹¶è¿”å›æŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼›
- `constexpr void deallocate(T* p, size_t n)`ï¼šé‡Šæ”¾åˆ†é…çš„å†…å­˜ã€‚p å¿…é¡»æ˜¯è°ƒç”¨ `allocate()` è·å¾—çš„æŒ‡é’ˆï¼Œn å¿…é¡»ç­‰äºè°ƒç”¨ `allocate()` æ—¶ä¼ å…¥çš„å‚æ•°ï¼›
- `void construct(T* p, Args ... args)`ï¼šä½¿ç”¨å‚æ•° args åœ¨ p å¤„æ„é€ ä¸€ä¸ªå¯¹è±¡ã€‚**C++20 ä¸­ç§»é™¤**ï¼›
- `void destroy(T* p)`ï¼šè°ƒç”¨ p å¤„å¯¹è±¡çš„ææ„å‡½æ•°ã€‚**C++20 ä¸­ç§»é™¤**ï¼›

> å¦‚æœå¸Œæœ›è‡ªå®šä¹‰åˆ†é…å™¨ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿è‡ª `std::allocator`ï¼Œç„¶åé‡å†™åˆ†é…/è§£åˆ†é…ç­–ç•¥ã€‚

## æœªåˆå§‹åŒ–å†…å­˜ç®—æ³•

> å®šä¹‰äºå¤´æ–‡ä»¶ `<memory>`

- `constexpr void destroy_at(T*)`ï¼šé”€æ¯åœ¨ç»™å®šåœ°å€çš„å¯¹è±¡ï¼›
- `constexpr void destroy(ForwardIt, ForwardIt)`ï¼šé”€æ¯ä¸€ä¸ªèŒƒå›´ä¸­çš„å¯¹è±¡ï¼›
- `constexpr ForwardIt destroy_n( ForwardIt first, Size n )`ï¼šé”€æ¯èŒƒå›´ä¸­ä¸€å®šæ•°é‡çš„å¯¹è±¡ï¼›
- `constexpr T* construct_at( T* p, Args&&... args )`ï¼šåœ¨ç»™å®šåœ°å€åˆ›å»ºå¯¹è±¡ï¼›

## æ™ºèƒ½æŒ‡é’ˆ

æ™ºèƒ½æŒ‡é’ˆæ˜¯é’ˆå¯¹è£¸æŒ‡é’ˆè¿›è¡Œå°è£…çš„ç±»ï¼Œå®ƒèƒ½å¤Ÿæ›´å®‰å…¨ã€æ›´æ–¹ä¾¿åœ°ä½¿ç”¨åŠ¨æ€å†…å­˜ã€‚å…·ä½“è§ [C++11 ã® æ™ºèƒ½æŒ‡é’ˆ](../../C/C-SmartPtr)ã€‚

## å†…å­˜æ³„æ¼åŠå…¶å¸¸ç”¨å·¥å…·

å¦‚æœä½¿ç”¨äº† `malloc()/new` åˆ†é…å†…å­˜å´æœªè°ƒç”¨ `free()/delete` é‡Šæ”¾ï¼Œé‚£ä¹ˆæŒ‡å‘è¯¥å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆï¼ˆé€šå¸¸åˆ†é…åœ¨æ ˆä¸Šï¼‰å°†ä¼šå› ä¸ºç”Ÿå‘½å‘¨æœŸç»“æŸè€Œè¢«é‡Šæ”¾ï¼Œä»è€Œæ°¸è¿œæ— æ³•è®¿é—®é‚£ç‰‡å†…å­˜ã€‚åœ¨æ“ä½œç³»ç»Ÿè§†è§’ä¸‹ï¼Œç¨‹åºå‘˜æ²¡é‡Šæ”¾ï¼Œé‚£å°±æ˜¯æœ‰å¯èƒ½ä½¿ç”¨ï¼Œè¿™å—å†…å­˜å°†è¢«ä¸€ç›´ä¿ç•™ã€‚ä¸€æ—¦è¿™ç§æƒ…å†µè¶Šæ¥è¶Šå¤šï¼Œé‚£ä¹ˆåç»­å†è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œå°†ä¼šæ²¡æœ‰å†…å­˜å¯ç”¨ï¼Œè¿™å°±æ˜¯**å†…å­˜æ³„æ¼**ã€‚

### Valgrind

Valgrind å¯ä»¥ç”¨æ¥æ£€æµ‹ç¨‹åºæ˜¯å¦æœ‰éæ³•ä½¿ç”¨å†…å­˜çš„é—®é¢˜ï¼Œä¾‹å¦‚è®¿é—®æœªåˆå§‹åŒ–çš„å†…å­˜ã€è®¿é—®æ•°ç»„æ—¶è¶Šç•Œã€å¿˜è®°é‡Šæ”¾åŠ¨æ€å†…å­˜ç­‰é—®é¢˜ã€‚

æ„å»ºé¡¹ç›®æ—¶åŠ ä¸Šç¼–è¯‘é€‰é¡¹ `-g`ï¼Œä¹‹åè°ƒç”¨ `valgrind --tool=memcheck --leak-check=full  {å¯æ‰§è¡Œæ–‡ä»¶}` å³å¯è¿›è¡Œå†…å­˜é—®é¢˜æ£€æµ‹ã€‚

### Address Sanitizer

AddressSanitizer æ˜¯ Google å¼€å‘çš„ä¸€æ¬¾ç”¨äºæ£€æµ‹å†…å­˜è®¿é—®é”™è¯¯çš„å·¥å…·ã€‚å®ƒå†…ç½®åœ¨ GCC ç‰ˆæœ¬ >= 4.8 ä¸­ï¼Œé€‚ç”¨äº C å’Œ C++ ä»£ç ã€‚å®ƒèƒ½å¤Ÿæ£€æµ‹ï¼š

- **Heap buffer overflow**ï¼šå †è¶Šç•Œè®¿é—®ï¼›
- **Stack buffer overflow**ï¼šæ ˆè¶Šç•Œè®¿é—®ï¼›
- **Global buffer overflow**ï¼šå…¨å±€ç¼“å†²åŒºè¶Šç•Œè®¿é—®ï¼›
- **Use after free**ï¼šè®¿é—®æŒ‡å‘*å·²é‡Šæ”¾å†…å­˜*çš„é‡æŒ‡é’ˆï¼›
- **Use after return**ï¼šè®¿é—®æŒ‡å‘*ç”Ÿå‘½å‘¨æœŸç»“æŸçš„å±€éƒ¨å˜é‡*çš„é‡æŒ‡é’ˆï¼›
- **Use after scope**ï¼šåŒä¸Šï¼›
- **Initialization order bugs**ï¼›
- **Memory leaks**ï¼šå†…å­˜æ³„æ¼ï¼Œå³åˆ†é…ä½†ä¸é‡Šæ”¾ï¼›

AddressSanitizer å¯åœ¨ä½¿ç”¨è¿è¡Œæ—¶æ£€æµ‹è·Ÿè¸ªå†…å­˜åˆ†é…ï¼Œè¿™æ„å‘³ç€å¿…é¡»ä½¿ç”¨ AddressSanitizer æ„å»ºä»£ç æ‰èƒ½åˆ©ç”¨å®ƒçš„åŠŸèƒ½ã€‚

æ„å»ºé¡¹ç›®æ—¶ï¼Œç”¨ `-fsanitize=address` é€‰é¡¹ç¼–è¯‘å’Œé“¾æ¥ï¼ˆåŒæ—¶è®°å¾—åŠ ä¸Šç¼–è¯‘é€‰é¡¹ `-g`ï¼‰ã€‚æ­¤æ—¶å¯æ‰§è¡Œæ–‡ä»¶å°±è¿›å…¥ ASan æ¨¡å¼ã€‚åœ¨ç¨‹åºè¿è¡Œæ—¶é¦–æ¬¡æ£€æµ‹åˆ°é—®é¢˜æ—¶ï¼Œä¼šæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºã€‚

```C++ main.c
int main() {
  int *ptr = new int(1);
  return 0;
}
```

```bash
$ gcc -fsanitize=address -g main.c -o main
$ ./main
# è¾“å‡ºé”™è¯¯ä¿¡æ¯
```

å’Œ Valgrind ç›¸æ¯”ï¼ŒAddressSanitizer **æ€§èƒ½æ›´é«˜**ã€‚